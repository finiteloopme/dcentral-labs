# Cloud Build Triggers Configuration
# Deploy these triggers using: gcloud builds triggers import --source=cloudbuild-triggers.yaml

triggers:
  # Trigger 1: Plan on Pull Request
  - name: 'terraform-plan-pr'
    description: 'Run Terraform plan on pull requests'
    github:
      owner: 'midnight-network'
      name: 'coding-platform'
      pullRequest:
        branch: '^main$'
        commentControl: 'COMMENTS_ENABLED'
    filename: 'cicd/cloudbuild/cloudbuild-plan.yaml'
    serviceAccount: 'projects/${PROJECT_ID}/serviceAccounts/midnight-cloudbuild-sa@${PROJECT_ID}.iam.gserviceaccount.com'
    substitutions:
      _ENVIRONMENT: 'prod'
      _REGION: 'us-central1'
      _ZONE: 'us-central1-a'
      _TRIGGERED_BY: '${TRIGGER_NAME}'
    approvalConfig:
      approvalRequired: true

  # Trigger 5: Deploy with External Proof Service
  - name: 'deploy-external-proof'
    description: 'Deploy with external proof service'
    github:
      owner: 'midnight-network'
      name: 'coding-platform'
      push:
        branch: '^feature/midnight-proof$'
    filename: 'cicd/cloudbuild/cloudbuild.yaml'
    substitutions:
      _ENVIRONMENT: 'dev'
      _TERRAFORM_ACTION: 'apply'
      _AUTO_APPROVE: 'true'
      _REGION: 'us-central1'
      _ZONE: 'us-central1-a'
    includedFiles:
      - 'terraform/**'
      - 'docker/**'

  # Trigger 6: Deploy with Manual Proof Configuration
  - name: 'deploy-manual-proof'
    description: 'Deploy with manually configured proof service'
    disabled: false
    sourceToBuild:
      uri: 'https://github.com/midnight-network/coding-platform'
      ref: 'refs/heads/main'
      repoType: 'GITHUB'
    filename: 'cicd/cloudbuild/cloudbuild.yaml'
    substitutions:
      _ENVIRONMENT: 'dev'
      _TERRAFORM_ACTION: 'apply'
      _AUTO_APPROVE: 'true'
      _REGION: 'us-central1'
      _ZONE: 'us-central1-a'

  # Trigger 7: Destroy Dev Environment (manual)
  - name: 'terraform-destroy-dev'
    description: 'Destroy dev environment (manual trigger)'
    sourceToBuild:
      uri: 'https://github.com/midnight-network/coding-platform'
      ref: 'refs/heads/main'
      repoType: 'GITHUB'
    disabled: true  # Safety: disabled by default
    filename: 'cloudbuild-destroy.yaml'
    substitutions:
      _ENVIRONMENT: 'dev'
      _REGION: 'us-central1'
      _ZONE: 'us-central1-a'