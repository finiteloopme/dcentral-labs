# Cloud Build configuration for Midnight GenAI Development Platform
#
# This pipeline:
# 1. Builds the dev container image
# 2. Pushes to Artifact Registry
# 3. Runs Terraform to deploy infrastructure
#
# Usage:
#   gcloud builds submit --config=cloudbuild.yaml \
#     --substitutions=_PROJECT_ID=$PROJECT_ID,_STATE_BUCKET=$STATE_BUCKET,...

substitutions:
  _PROJECT_ID: ${PROJECT_ID}
  _REGION: us-central1
  _STATE_BUCKET: ${STATE_BUCKET}
  _STATE_PREFIX: terraform/state
  _CLUSTER_NAME: midnight-dev
  _GKE_CLUSTER_NAME: midnight-dev-gke
  _IMAGE_NAME: midnight-dev-platform
  _IMAGE_TAG: latest
  _ENVIRONMENT: dev
  _CHAIN_ENVIRONMENT: standalone
  _MIDNIGHT_NODE_IMAGE: midnightnetwork/midnight-node:0.12.1
  _PROOF_SERVER_IMAGE: midnightnetwork/proof-server:4.0.0
  _INDEXER_IMAGE: midnightntwrk/indexer-standalone:2.1.4
  _INDEXER_SECRET: ""
  _MACHINE_TYPE: e2-standard-4
  _PERSISTENT_DISK_SIZE_GB: "100"
  _CLOUDBUILD_SA_EMAIL: ""

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8

steps:
  # Step 1: Initialize Terraform and create base infrastructure (APIs, Artifact Registry)
  - name: 'hashicorp/terraform:1.14'
    id: 'tf-init'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd terraform
        terraform init \
          -backend-config="bucket=${_STATE_BUCKET}" \
          -backend-config="prefix=${_STATE_PREFIX}"
        
        # First, apply only the APIs and Artifact Registry to enable docker push
        # This uses -target to create just the prerequisites
        echo "=== Creating Artifact Registry (if needed) ==="
        terraform apply -auto-approve \
          -var="project_id=${_PROJECT_ID}" \
          -var="region=${_REGION}" \
          -var="cluster_name=${_CLUSTER_NAME}" \
          -var="gke_cluster_name=${_GKE_CLUSTER_NAME}" \
          -var="environment=${_ENVIRONMENT}" \
          -var="chain_environment=${_CHAIN_ENVIRONMENT}" \
          -var="container_image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/midnight-dev/${_IMAGE_NAME}:${_IMAGE_TAG}" \
          -var="midnight_node_image=${_MIDNIGHT_NODE_IMAGE}" \
          -var="proof_server_image=${_PROOF_SERVER_IMAGE}" \
          -var="indexer_image=${_INDEXER_IMAGE}" \
          -var="indexer_secret=${_INDEXER_SECRET}" \
          -var="machine_type=${_MACHINE_TYPE}" \
          -var="persistent_disk_size_gb=${_PERSISTENT_DISK_SIZE_GB}" \
          -var="cloudbuild_sa_email=${_CLOUDBUILD_SA_EMAIL}" \
          -target=google_project_service.apis \
          -target=module.artifact_registry
    waitFor: ['-']  # Start immediately

  # Step 2: Build the dev container image
  # Use BUILD_ID as fallback when SHORT_SHA is not available (manual builds)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TAG="${SHORT_SHA:-$BUILD_ID}"
        docker build \
          -t "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/midnight-dev/${_IMAGE_NAME}:${_IMAGE_TAG}" \
          -t "${_REGION}-docker.pkg.dev/${_PROJECT_ID}/midnight-dev/${_IMAGE_NAME}:$${TAG}" \
          .
    waitFor: ['tf-init']  # Wait for Terraform to create Artifact Registry

  # Step 3: Push image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-image'
    args:
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/midnight-dev/${_IMAGE_NAME}'
    waitFor: ['build-image']

  # Step 4: Terraform Plan
  - name: 'hashicorp/terraform:1.14'
    id: 'tf-plan'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd terraform
        terraform plan \
          -var="project_id=${_PROJECT_ID}" \
          -var="region=${_REGION}" \
          -var="cluster_name=${_CLUSTER_NAME}" \
          -var="gke_cluster_name=${_GKE_CLUSTER_NAME}" \
          -var="environment=${_ENVIRONMENT}" \
          -var="chain_environment=${_CHAIN_ENVIRONMENT}" \
          -var="container_image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/midnight-dev/${_IMAGE_NAME}:${_IMAGE_TAG}" \
          -var="midnight_node_image=${_MIDNIGHT_NODE_IMAGE}" \
          -var="proof_server_image=${_PROOF_SERVER_IMAGE}" \
          -var="indexer_image=${_INDEXER_IMAGE}" \
          -var="indexer_secret=${_INDEXER_SECRET}" \
          -var="machine_type=${_MACHINE_TYPE}" \
          -var="persistent_disk_size_gb=${_PERSISTENT_DISK_SIZE_GB}" \
          -var="cloudbuild_sa_email=${_CLOUDBUILD_SA_EMAIL}" \
          -out=tfplan
    waitFor: ['tf-init', 'push-image']

  # Step 5: Terraform Apply
  - name: 'hashicorp/terraform:1.14'
    id: 'tf-apply'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd terraform
        terraform apply -auto-approve tfplan
    waitFor: ['tf-plan']

  # Step 6: Output service URLs
  - name: 'hashicorp/terraform:1.14'
    id: 'tf-output'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        cd terraform
        echo "=========================================="
        echo "Deployment Complete!"
        echo "=========================================="
        terraform output -json
    waitFor: ['tf-apply']

# Build timeout (45 minutes - allows for GKE cluster creation/recreation)
timeout: 2700s

# Images to be pushed (only the :latest tag, BUILD_ID tag is pushed in step 2)
images:
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/midnight-dev/${_IMAGE_NAME}:${_IMAGE_TAG}'
