#!/bin/bash
# Midnight Development Helper - npm-based workflow
# Provides commands for Midnight smart contract development

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
MIDNIGHT_DEV_DIR="$HOME/midnight-dev"
PROJECTS_DIR="$MIDNIGHT_DEV_DIR/projects"

# Help function
show_help() {
    echo -e "${BLUE}üåô Midnight Development Helper${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC} midnight-dev [command] [options]"
    echo ""
    echo -e "${YELLOW}Commands:${NC}"
    echo -e "  ${GREEN}init${NC} [project-name]     Initialize new Midnight contract project"
    echo -e "  ${GREEN}list${NC}                     List all Midnight projects"
    echo -e "  ${GREEN}compile${NC} [project-name]    Compile contracts in project"
    echo -e "  ${GREEN}build${NC} [project-name]      Build project (compile + prepare)"
    echo -e "  ${GREEN}clean${NC} [project-name]      Clean build artifacts"
    echo -e "  ${GREEN}status${NC}                    Show development environment status"
    echo -e "  ${GREEN}help${NC}                       Show this help message"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo -e "  midnight-dev init my-contract"
    echo -e "  midnight-dev compile my-contract"
    echo -e "  midnight-dev list"
}

# Initialize new project
init_project() {
    local project_name=${1:-"midnight-contract"}
    local project_path="$PROJECTS_DIR/$project_name"
    
    echo -e "${BLUE}üåô Initializing Midnight Project: ${project_name}${NC}"
    
    # Create projects directory if it doesn't exist
    mkdir -p "$PROJECTS_DIR"
    
    # Check if project already exists
    if [ -d "$project_path" ]; then
        echo -e "${RED}‚ùå Project '$project_name' already exists at $project_path${NC}"
        exit 1
    fi
    
    # Initialize project using template
    if [ -x /usr/local/bin/init-midnight-project ]; then
        cd "$PROJECTS_DIR"
        init-midnight-project "$project_name"
        echo -e "${GREEN}‚úÖ Project '$project_name' created successfully!${NC}"
        echo -e "${BLUE}üìÅ Location: $project_path${NC}"
        echo -e "${YELLOW}üí° Next steps:${NC}"
        echo -e "  cd $project_path"
        echo -e "  # Edit contracts in src/contracts/"
        echo -e "  npm run compile"
        echo -e ""
        echo -e "${BLUE}üîß Working compilation workflow:${NC}"
        echo -e "  - Uses Node.js script to handle Compact compiler metadata"
        echo -e "  - Generates TypeScript and circuit files"
        echo -e "  - Skips ZK proof generation for faster development"
    else
        echo -e "${RED}‚ùå Midnight project initializer not found${NC}"
        exit 1
    fi
}

# List projects
list_projects() {
    echo -e "${BLUE}üåô Midnight Projects:${NC}"
    echo ""
    
    if [ ! -d "$PROJECTS_DIR" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No projects directory found${NC}"
        return 1
    fi
    
    local projects=($(ls -1 "$PROJECTS_DIR" 2>/dev/null))
    
    if [ ${#projects[@]} -eq 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  No projects found${NC}"
        echo -e "${BLUE}üí° Create your first project with:${NC}"
        echo -e "  midnight-dev init my-contract"
        return 0
    fi
    
    for project in "${projects[@]}"; do
        local project_path="$PROJECTS_DIR/$project"
        if [ -f "$project_path/package.json" ]; then
            local version=$(grep -o '"version": "[^"]*"' "$project_path/package.json" | cut -d'"' -f4)
            echo -e "  ${GREEN}‚úÖ $project${NC} (v${version:-unknown})"
        else
            echo -e "  ${YELLOW}‚ö†Ô∏è  $project${NC} (not a valid npm project)"
        fi
    done
}

# Compile project
compile_project() {
    local project_name=${1:-""}
    
    if [ -z "$project_name" ]; then
        echo -e "${RED}‚ùå Project name required${NC}"
        echo -e "${BLUE}Usage: midnight-dev compile <project-name>${NC}"
        return 1
    fi
    
    local project_path="$PROJECTS_DIR/$project_name"
    
    if [ ! -d "$project_path" ]; then
        echo -e "${RED}‚ùå Project '$project_name' not found${NC}"
        return 1
    fi
    
    if [ ! -f "$project_path/package.json" ]; then
        echo -e "${RED}‚ùå '$project_name' is not a valid npm project${NC}"
        return 1
    fi
    
    echo -e "${BLUE}üî® Compiling contracts in project: $project_name${NC}"
    
    # Ensure compact configuration exists before compilation
    if [ ! -f "$HOME/.compact/config.toml" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Creating compact configuration...${NC}"
        mkdir -p "$HOME/.compact"
        cat > "$HOME/.compact/config.toml" << 'COMPACTCONFIG'
[compiler]
default = "0.25.0"
COMPACTCONFIG
        chmod 644 "$HOME/.compact/config.toml"
        echo -e "${GREEN}‚úÖ Compact configuration created${NC}"
    fi
    
    cd "$project_path"
    
    if npm run compile; then
        echo -e "${GREEN}‚úÖ Compilation successful!${NC}"
        if [ -d "dist/contracts" ]; then
            local contracts=$(ls -1 dist/contracts/ 2>/dev/null | wc -l)
            echo -e "${BLUE}üìÑ Generated $contracts contract file(s)${NC}"
        fi
    else
        echo -e "${RED}‚ùå Compilation failed${NC}"
        return 1
    fi
}

# Build project
build_project() {
    local project_name=${1:-""}
    
    if [ -z "$project_name" ]; then
        echo -e "${RED}‚ùå Project name required${NC}"
        echo -e "${BLUE}Usage: midnight-dev build <project-name>${NC}"
        return 1
    fi
    
    local project_path="$PROJECTS_DIR/$project_name"
    
    if [ ! -d "$project_path" ]; then
        echo -e "${RED}‚ùå Project '$project_name' not found${NC}"
        return 1
    fi
    
    echo -e "${BLUE}üèóÔ∏è  Building project: $project_name${NC}"
    
    cd "$project_path"
    
    if npm run build; then
        echo -e "${GREEN}‚úÖ Build successful!${NC}"
    else
        echo -e "${RED}‚ùå Build failed${NC}"
        return 1
    fi
}

# Clean project
clean_project() {
    local project_name=${1:-""}
    
    if [ -z "$project_name" ]; then
        echo -e "${RED}‚ùå Project name required${NC}"
        echo -e "${BLUE}Usage: midnight-dev clean <project-name>${NC}"
        return 1
    fi
    
    local project_path="$PROJECTS_DIR/$project_name"
    
    if [ ! -d "$project_path" ]; then
        echo -e "${RED}‚ùå Project '$project_name' not found${NC}"
        return 1
    fi
    
    echo -e "${BLUE}üßπ Cleaning project: $project_name${NC}"
    
    cd "$project_path"
    
    if npm run clean 2>/dev/null || rm -rf dist; then
        echo -e "${GREEN}‚úÖ Clean successful!${NC}"
    else
        echo -e "${RED}‚ùå Clean failed${NC}"
        return 1
    fi
}

# Show status
show_status() {
    echo -e "${BLUE}üåô Midnight Development Environment Status${NC}"
    echo ""
    
    # Check Node.js
    if command -v node >/dev/null 2>&1; then
        echo -e "  ${GREEN}‚úÖ Node.js${NC} $(node --version)"
    else
        echo -e "  ${RED}‚ùå Node.js${NC} not found"
    fi
    
    # Check npm
    if command -v npm >/dev/null 2>&1; then
        echo -e "  ${GREEN}‚úÖ npm${NC} $(npm --version)"
    else
        echo -e "  ${RED}‚ùå npm${NC} not found"
    fi
    
    # Check compact
    if command -v compact >/dev/null 2>&1; then
        echo -e "  ${GREEN}‚úÖ Compact CLI${NC} $(compact --version 2>/dev/null | head -1)"
    else
        echo -e "  ${RED}‚ùå Compact CLI${NC} not found"
    fi
    
    # Check compactc
    if command -v compactc >/dev/null 2>&1; then
        echo -e "  ${GREEN}‚úÖ Compact Compiler${NC} $(compactc --version 2>/dev/null)"
    else
        echo -e "  ${RED}‚ùå Compact Compiler${NC} not found"
    fi
    
    # Check development directories
    if [ -d "$MIDNIGHT_DEV_DIR" ]; then
        echo -e "  ${GREEN}‚úÖ Midnight Dev Directory${NC} $MIDNIGHT_DEV_DIR"
    else
        echo -e "  ${RED}‚ùå Midnight Dev Directory${NC} not found"
    fi
    
    # Check projects
    if [ -d "$PROJECTS_DIR" ]; then
        local project_count=$(ls -1 "$PROJECTS_DIR" 2>/dev/null | wc -l)
        echo -e "  ${GREEN}‚úÖ Projects${NC} $project_count project(s)"
    else
        echo -e "  ${YELLOW}‚ö†Ô∏è  Projects Directory${NC} not created yet"
    fi
    
    echo ""
    echo -e "${BLUE}üöÄ Quick start:${NC}"
    echo -e "  midnight-dev init my-contract    # Create first project"
    echo -e "  midnight-dev list                # List projects"
    echo -e "  midnight-dev compile my-contract  # Compile contracts"
}

# Main logic
case "${1:-help}" in
    init)
        init_project "$2"
        ;;
    list)
        list_projects
        ;;
    compile)
        compile_project "$2"
        ;;
    build)
        build_project "$2"
        ;;
    clean)
        clean_project "$2"
        ;;
    status)
        show_status
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac